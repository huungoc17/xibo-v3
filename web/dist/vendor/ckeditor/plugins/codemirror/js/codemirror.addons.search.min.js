!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define("addon/search/searchcursor",["../../lib/codemirror"],e):e(CodeMirror)}((function(e){function n(e,n){for(var t,o=t=null!=(t=e.flags)?t:(e.ignoreCase?"i":"")+(e.global?"g":"")+(e.multiline?"m":""),r=0;r<n.length;r++)-1==o.indexOf(n.charAt(r))&&(o+=n.charAt(r));return t==o?e:new RegExp(e.source,o)}function t(e,t,o){t=n(t,"g");var r=o.line,i=o.ch;for(o=e.lastLine();r<=o;r++,i=0)if(t.lastIndex=i,i=e.getLine(r),i=t.exec(i))return{from:p(r,i.index),to:p(r,i.index+i[0].length),match:i}}function o(e,o,r){if(!/\\s|\\n|\n|\\W|\\D|\[\^/.test(o.source))return t(e,o,r);o=n(o,"gm");for(var i,s=1,l=r.line,a=e.lastLine();l<=a;){for(var c=0;c<s&&!(l>a);c++){var u=e.getLine(l++);i=null==i?u:i+"\n"+u}if(s*=2,o.lastIndex=r.ch,c=o.exec(i))return o=i.slice(0,c.index).split("\n"),e=c[0].split("\n"),r=r.line+o.length-1,o=o[o.length-1].length,{from:p(r,o),to:p(r+e.length-1,1==e.length?o+e[0].length:e[e.length-1].length),match:c}}}function r(e,n,t){for(var o,r=0;r<=e.length&&(n.lastIndex=r,r=n.exec(e));){var i=r.index+r[0].length;if(i>e.length-t)break;(!o||i>o.index+o[0].length)&&(o=r),r=r.index+1}return o}function i(e,t,o){t=n(t,"g");var i=o.line,s=o.ch;for(o=e.firstLine();i>=o;i--,s=-1){var l=e.getLine(i);if(s=r(l,t,0>s?0:l.length-s))return{from:p(i,s.index),to:p(i,s.index+s[0].length),match:s}}}function s(e,t,o){if(!/\\s|\\n|\n|\\W|\\D|\[\^/.test(t.source))return i(e,t,o);t=n(t,"gm");var s,l=1,a=e.getLine(o.line).length-o.ch;o=o.line;for(var c=e.firstLine();o>=c;){for(var u=0;u<l&&o>=c;u++){var f=e.getLine(o--);s=null==s?f:f+"\n"+s}if(l*=2,u=r(s,t,a))return t=s.slice(0,u.index).split("\n"),e=u[0].split("\n"),o+=t.length,t=t[t.length-1].length,{from:p(o,t),to:p(o+e.length-1,1==e.length?t+e[0].length:e[e.length-1].length),match:u}}}function l(e,n,t,o){if(e.length==n.length)return t;var r=0;for(n=t+Math.max(0,e.length-n.length);;){if(r==n)return r;var i=r+n>>1,s=o(e.slice(0,i)).length;if(s==t)return i;s>t?n=i:r=i+1}}function a(e,n,t,o){if(!n.length)return null;n=(o=o?f:h)(n).split(/\r|\n\r?/);var r=t.line;t=t.ch;var i=e.lastLine()+1-n.length;e:for(;r<=i;r++,t=0){var s=e.getLine(r).slice(t),a=o(s);if(1==n.length){var c=a.indexOf(n[0]);if(-1==c)continue e;return l(s,a,c,o),{from:p(r,l(s,a,c,o)+t),to:p(r,l(s,a,c+n[0].length,o)+t)}}if(c=a.length-n[0].length,a.slice(c)==n[0]){for(var u=1;u<n.length-1;u++)if(o(e.getLine(r+u))!=n[u])continue e;var d=o(u=e.getLine(r+n.length-1)),g=n[n.length-1];if(d.slice(0,g.length)==g)return{from:p(r,l(s,a,c,o)+t),to:p(r+n.length-1,l(u,d,g.length,o))}}}}function c(e,n,t,o){if(!n.length)return null;n=(o=o?f:h)(n).split(/\r|\n\r?/);var r=t.line,i=t.ch,s=e.firstLine()-1+n.length;e:for(;r>=s;r--,i=-1){var a=e.getLine(r);if(-1<i&&(a=a.slice(0,i)),i=o(a),1==n.length){if(-1==(t=i.lastIndexOf(n[0])))continue e;return{from:p(r,l(a,i,t,o)),to:p(r,l(a,i,t+n[0].length,o))}}var c=n[n.length-1];if(i.slice(0,c.length)==c){var u=1;for(t=r-n.length+1;u<n.length-1;u++)if(o(e.getLine(t+u))!=n[u])continue e;if((u=o(t=e.getLine(r+1-n.length))).slice(u.length-n[0].length)==n[0])return{from:p(r+1-n.length,l(t,u,t.length-n[0].length,o)),to:p(r,l(a,i,c.length,o))}}}}function u(e,r,l,u){var f;this.atOccurrence=!1,this.doc=e,l=l?e.clipPos(l):p(0,0),this.pos={from:l,to:l},"object"==typeof u?f=u.caseFold:(f=u,u=null),"string"==typeof r?(null==f&&(f=!1),this.matches=function(n,t){return(n?c:a)(e,r,t,f)}):(r=n(r,"gm"),u&&!1===u.multiline?this.matches=function(n,o){return(n?i:t)(e,r,o)}:this.matches=function(n,t){return(n?s:o)(e,r,t)})}var f,h,p=e.Pos;String.prototype.normalize?(f=function(e){return e.normalize("NFD").toLowerCase()},h=function(e){return e.normalize("NFD")}):(f=function(e){return e.toLowerCase()},h=function(e){return e}),u.prototype={findNext:function(){return this.find(!1)},findPrevious:function(){return this.find(!0)},find:function(n){for(var t=this.matches(n,this.doc.clipPos(n?this.pos.from:this.pos.to));t&&0==e.cmpPos(t.from,t.to);)n?t.from.ch?t.from=p(t.from.line,t.from.ch-1):t=t.from.line==this.doc.firstLine()?null:this.matches(n,this.doc.clipPos(p(t.from.line-1))):t.to.ch<this.doc.getLine(t.to.line).length?t.to=p(t.to.line,t.to.ch+1):t=t.to.line==this.doc.lastLine()?null:this.matches(n,p(t.to.line+1,0));return t?(this.pos=t,this.atOccurrence=!0,this.pos.match||!0):(n=p(n?this.doc.firstLine():this.doc.lastLine()+1,0),this.pos={from:n,to:n},this.atOccurrence=!1)},from:function(){if(this.atOccurrence)return this.pos.from},to:function(){if(this.atOccurrence)return this.pos.to},replace:function(n,t){if(this.atOccurrence){var o=e.splitLines(n);this.doc.replaceRange(o,this.pos.from,this.pos.to,t),this.pos.to=p(this.pos.from.line+o.length-1,o[o.length-1].length+(1==o.length?this.pos.from.ch:0))}}},e.defineExtension("getSearchCursor",(function(e,n,t){return new u(this.doc,e,n,t)})),e.defineDocExtension("getSearchCursor",(function(e,n,t){return new u(this,e,n,t)})),e.defineExtension("selectMatches",(function(n,t){for(var o=[],r=this.getSearchCursor(n,this.getCursor("from"),t);r.findNext()&&!(0<e.cmpPos(r.to(),this.getCursor("to")));)o.push({anchor:r.from(),head:r.to()});o.length&&this.setSelections(o,0)}))})),function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define("addon/dialog/dialog",["../../lib/codemirror"],e):e(CodeMirror)}((function(e){function n(n,t,o){var r;return(r=(n=n.getWrapperElement()).appendChild(document.createElement("div"))).className=o?"CodeMirror-dialog CodeMirror-dialog-bottom":"CodeMirror-dialog CodeMirror-dialog-top","string"==typeof t?r.innerHTML=t:r.appendChild(t),e.addClass(n,"dialog-opened"),r}function t(e,n){e.state.currentNotificationClose&&e.state.currentNotificationClose(),e.state.currentNotificationClose=n}e.defineExtension("openDialog",(function(o,r,i){function s(n){"string"==typeof n?f.value=n:c||(c=!0,e.rmClass(a.parentNode,"dialog-opened"),a.parentNode.removeChild(a),u.focus(),i.onClose&&i.onClose(a))}i||(i={}),t(this,null);var l,a=n(this,o,i.bottom),c=!1,u=this,f=a.getElementsByTagName("input")[0];return f?(f.focus(),i.value&&(f.value=i.value,!1!==i.selectValueOnOpen&&f.select()),i.onInput&&e.on(f,"input",(function(e){i.onInput(e,f.value,s)})),i.onKeyUp&&e.on(f,"keyup",(function(e){i.onKeyUp(e,f.value,s)})),e.on(f,"keydown",(function(n){i&&i.onKeyDown&&i.onKeyDown(n,f.value,s)||((27==n.keyCode||!1!==i.closeOnEnter&&13==n.keyCode)&&(f.blur(),e.e_stop(n),s()),13==n.keyCode&&r(f.value,n))})),!1!==i.closeOnBlur&&e.on(a,"focusout",(function(e){null!==e.relatedTarget&&s()}))):(l=a.getElementsByTagName("button")[0])&&(e.on(l,"click",(function(){s(),u.focus()})),!1!==i.closeOnBlur&&e.on(l,"blur",s),l.focus()),s})),e.defineExtension("openConfirm",(function(o,r,i){function s(){a||(a=!0,e.rmClass(l.parentNode,"dialog-opened"),l.parentNode.removeChild(l),c.focus())}t(this,null);var l=n(this,o,i&&i.bottom);o=l.getElementsByTagName("button");var a=!1,c=this,u=1;for(o[0].focus(),i=0;i<o.length;++i){var f=o[i];!function(n){e.on(f,"click",(function(t){e.e_preventDefault(t),s(),n&&n(c)}))}(r[i]),e.on(f,"blur",(function(){--u,setTimeout((function(){0>=u&&s()}),200)})),e.on(f,"focus",(function(){++u}))}})),e.defineExtension("openNotification",(function(o,r){function i(){a||(a=!0,clearTimeout(s),e.rmClass(l.parentNode,"dialog-opened"),l.parentNode.removeChild(l))}t(this,i);var s,l=n(this,o,r&&r.bottom),a=!1,c=r&&void 0!==r.duration?r.duration:5e3;return e.on(l,"click",(function(n){e.e_preventDefault(n),i()})),c&&(s=setTimeout(i,c)),i}))})),function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define("addon/search/search.js",["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}((function(e){function n(){this.overlay=this.posFrom=this.posTo=this.lastQuery=this.query=null}function t(e){return e.state.search||(e.state.search=new n)}function o(e){return"string"==typeof e&&e==e.toLowerCase()}function r(e,n,t){return e.getSearchCursor(n,t,{caseFold:o(n),multiline:!0})}function i(e,n,t,o,r){e.openDialog(n,o,{value:t,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){h(e)},onKeyDown:r,bottom:e.options.search.bottom})}function s(e,n,t,o,r){e.openDialog?e.openDialog(n,r,{value:o,selectValueOnOpen:!0,bottom:e.options.search.bottom}):r(prompt(t,o))}function l(e){return e.replace(/\\([nrt\\])/g,(function(e,n){return"n"==n?"\n":"r"==n?"\r":"t"==n?"\t":"\\"==n?"\\":e}))}function a(e){var n=e.match(/^\/(.*)\/([a-z]*)$/);if(n)try{e=new RegExp(n[1],-1==n[2].indexOf("i")?"":"i")}catch(e){}else e=l(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function c(e,n,t){n.queryText=t,n.query=a(t),e.removeOverlay(n.overlay,o(n.query)),n.overlay=function(e,n){return"string"==typeof e?e=new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n?"gi":"g"):e.global||(e=new RegExp(e.source,e.ignoreCase?"gi":"g")),{token:function(n){e.lastIndex=n.pos;var t=e.exec(n.string);if(t&&t.index==n.pos)return n.pos+=t[0].length||1,"searching";t?n.pos=t.index:n.skipToEnd()}}}(n.query,o(n.query)),e.addOverlay(n.overlay),e.showMatchesOnScrollbar&&(n.annotate&&(n.annotate.clear(),n.annotate=null),n.annotate=e.showMatchesOnScrollbar(n.query,o(n.query)))}function u(n,o,r,l){var a=t(n);if(a.query)return f(n,o);var u=n.getSelection()||a.lastQuery;if(u instanceof RegExp&&"x^"==u.source&&(u=null),r&&n.openDialog){var h=null,d=function(t,o){e.e_stop(o),t&&(t!=a.queryText&&(c(n,a,t),a.posFrom=a.posTo=n.getCursor()),h&&(h.style.opacity=1),f(n,o.shiftKey,(function(e,t){var o;3>t.line&&document.querySelector&&(o=n.display.wrapper.querySelector(".CodeMirror-dialog"))&&o.getBoundingClientRect().bottom-4>n.cursorCoords(t,"window").top&&((h=o).style.opacity=.4)})))};i(n,p(n),u,d,(function(o,r){var i=e.keyName(o),s=n.getOption("extraKeys");"findNext"==(i=s&&s[i]||e.keyMap[n.getOption("keyMap")][i])||"findPrev"==i||"findPersistentNext"==i||"findPersistentPrev"==i?(e.e_stop(o),c(n,t(n),r),n.execCommand(i)):"find"!=i&&"findPersistent"!=i||(e.e_stop(o),d(r,o))})),l&&u&&(c(n,a,u),f(n,o))}else s(n,p(n),"Search for:",u,(function(e){e&&!a.query&&n.operation((function(){c(n,a,e),a.posFrom=a.posTo=n.getCursor(),f(n,o)}))}))}function f(n,o,i){n.operation((function(){var s=t(n),l=r(n,s.query,o?s.posFrom:s.posTo);(l.find(o)||(l=r(n,s.query,o?e.Pos(n.lastLine()):e.Pos(n.firstLine(),0))).find(o))&&(n.setSelection(l.from(),l.to()),n.scrollIntoView({from:l.from(),to:l.to()},20),s.posFrom=l.from(),s.posTo=l.to(),i&&i(l.from(),l.to()))}))}function h(e){e.operation((function(){var n=t(e);(n.lastQuery=n.query)&&(n.query=n.queryText=null,e.removeOverlay(n.overlay),n.annotate&&(n.annotate.clear(),n.annotate=null))}))}function p(e){return'<span class="CodeMirror-search-label">'+e.phrase("Search:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}function d(e,n,t){e.operation((function(){for(var o=r(e,n);o.findNext();)if("string"!=typeof n){var i=e.getRange(o.from(),o.to()).match(n);o.replace(t.replace(/\$(\d)/g,(function(e,n){return i[n]})))}else o.replace(t)}))}function g(e,n){if(!e.getOption("readOnly")){var o=e.getSelection()||t(e).lastQuery,i='<span class="CodeMirror-search-label">'+(n?e.phrase("Replace all:"):e.phrase("Replace:"))+"</span>";s(e,i+' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>",i,o,(function(t){t&&(t=a(t),s(e,'<span class="CodeMirror-search-label">'+e.phrase("With:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',e.phrase("Replace with:"),"",(function(o){if(o=l(o),n)d(e,t,o);else{h(e);var i=r(e,t,e.getCursor("from")),s=function(){var n,l=i.from();!(n=i.findNext())&&(i=r(e,t),!(n=i.findNext())||l&&i.from().line==l.line&&i.from().ch==l.ch)||(e.setSelection(i.from(),i.to()),e.scrollIntoView({from:i.from(),to:i.to()}),function(e,n,t,o){e.openConfirm?e.openConfirm(n,o):confirm(t)&&o[0]()}(e,function(e){return'<span class="CodeMirror-search-label">'+e.phrase("Replace?")+"</span> <button>"+e.phrase("Yes")+"</button> <button>"+e.phrase("No")+"</button> <button>"+e.phrase("All")+"</button> <button>"+e.phrase("Stop")+"</button> "}(e),e.phrase("Replace?"),[function(){a(n)},s,function(){d(e,t,o)}]))},a=function(e){i.replace("string"==typeof t?o:o.replace(/\$(\d)/g,(function(n,t){return e[t]}))),s()};s()}})))}))}}e.defineOption("search",{bottom:!1}),e.commands.find=function(e){h(e),u(e)},e.commands.findPersistent=function(e){h(e),u(e,!1,!0)},e.commands.findPersistentNext=function(e){u(e,!1,!0,!0)},e.commands.findPersistentPrev=function(e){u(e,!0,!0,!0)},e.commands.findNext=u,e.commands.findPrev=function(e){u(e,!0)},e.commands.clearSearch=h,e.commands.replace=g,e.commands.replaceAll=function(e){g(e,!0)}})),function(e){"function"==typeof e.define&&e.define("addonSearch",["addon/search/search.js"],(function(){}))}(this);